<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ANSI_X3.4-1968">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE BangPatterns        #-}
<span class="lineno">    2 </span>{-# LANGUAGE CPP                 #-}
<span class="lineno">    3 </span>{-# LANGUAGE DeriveDataTypeable  #-}
<span class="lineno">    4 </span>{-# LANGUAGE OverloadedStrings   #-}
<span class="lineno">    5 </span>{-# LANGUAGE RankNTypes          #-}
<span class="lineno">    6 </span>{-# LANGUAGE ScopedTypeVariables #-}
<span class="lineno">    7 </span>
<span class="lineno">    8 </span>module Snap.Internal.Http.Server.Session
<span class="lineno">    9 </span>  ( httpAcceptLoop
<span class="lineno">   10 </span>  , httpSession
<span class="lineno">   11 </span>  , snapToServerHandler
<span class="lineno">   12 </span>  , BadRequestException(..)
<span class="lineno">   13 </span>  , LengthRequiredException(..)
<span class="lineno">   14 </span>  , TerminateSessionException(..)
<span class="lineno">   15 </span>  ) where
<span class="lineno">   16 </span>
<span class="lineno">   17 </span>------------------------------------------------------------------------------
<span class="lineno">   18 </span>#if !MIN_VERSION_base(4,8,0)
<span class="lineno">   19 </span>import           Control.Applicative                      ((&lt;$&gt;))
<span class="lineno">   20 </span>#endif
<span class="lineno">   21 </span>import           Control.Arrow                            (first, second)
<span class="lineno">   22 </span>import           Control.Concurrent                       (MVar, newEmptyMVar, putMVar, readMVar)
<span class="lineno">   23 </span>import           Control.Exception                        (AsyncException, Exception, Handler (..), SomeException (..))
<span class="lineno">   24 </span>import qualified Control.Exception                        as E
<span class="lineno">   25 </span>import           Control.Monad                            (join, unless, void, when, (&gt;=&gt;))
<span class="lineno">   26 </span>import           Data.ByteString.Char8                    (ByteString)
<span class="lineno">   27 </span>import qualified Data.ByteString.Char8                    as S
<span class="lineno">   28 </span>import qualified Data.ByteString.Unsafe                   as S
<span class="lineno">   29 </span>import qualified Data.CaseInsensitive                     as CI
<span class="lineno">   30 </span>import           Data.Int                                 (Int64)
<span class="lineno">   31 </span>import           Data.IORef                               (IORef, newIORef, readIORef, writeIORef)
<span class="lineno">   32 </span>import           Data.List                                (foldl')
<span class="lineno">   33 </span>import qualified Data.Map                                 as Map
<span class="lineno">   34 </span>import           Data.Maybe                               (fromJust, fromMaybe, isNothing)
<span class="lineno">   35 </span>#if !MIN_VERSION_base(4,8,0)
<span class="lineno">   36 </span>import           Data.Monoid                              (mconcat)
<span class="lineno">   37 </span>#endif
<span class="lineno">   38 </span>import           Data.Monoid                              ((&lt;&gt;))
<span class="lineno">   39 </span>import           Data.Time.Format                         (formatTime)
<span class="lineno">   40 </span>import           Data.Typeable                            (Typeable)
<span class="lineno">   41 </span>import           Data.Version                             (showVersion)
<span class="lineno">   42 </span>import           Data.Word                                (Word64, Word8)
<span class="lineno">   43 </span>import           Foreign.Marshal.Utils                    (copyBytes)
<span class="lineno">   44 </span>import           Foreign.Ptr                              (Ptr, castPtr, plusPtr)
<span class="lineno">   45 </span>import           Foreign.Storable                         (pokeByteOff)
<span class="lineno">   46 </span>#if MIN_VERSION_time(1,5,0)
<span class="lineno">   47 </span>import           Data.Time.Format                         (defaultTimeLocale)
<span class="lineno">   48 </span>#else
<span class="lineno">   49 </span>import           System.Locale                            (defaultTimeLocale)
<span class="lineno">   50 </span>#endif
<span class="lineno">   51 </span>------------------------------------------------------------------------------
<span class="lineno">   52 </span>import           Data.ByteString.Builder                  (Builder, byteString, char8, stringUtf8)
<span class="lineno">   53 </span>import           Data.ByteString.Builder.Extra            (flush)
<span class="lineno">   54 </span>import           Data.ByteString.Builder.Internal         (Buffer, defaultChunkSize, newBuffer)
<span class="lineno">   55 </span>import           Data.ByteString.Builder.Prim             (FixedPrim, primFixed, (&gt;$&lt;), (&gt;*&lt;))
<span class="lineno">   56 </span>import           Data.ByteString.Builder.Prim.Internal    (fixedPrim, size)
<span class="lineno">   57 </span>import           System.IO.Streams                        (InputStream, OutputStream)
<span class="lineno">   58 </span>import qualified System.IO.Streams                        as Streams
<span class="lineno">   59 </span>------------------------------------------------------------------------------
<span class="lineno">   60 </span>import qualified Paths_snap_server                        as V
<span class="lineno">   61 </span>import           Snap.Core                                (EscapeSnap (..))
<span class="lineno">   62 </span>import           Snap.Core                                (Snap, runSnap)
<span class="lineno">   63 </span>import           Snap.Internal.Core                       (fixupResponse)
<span class="lineno">   64 </span>import           Snap.Internal.Http.Server.Clock          (getClockTime)
<span class="lineno">   65 </span>import           Snap.Internal.Http.Server.Common         (eatException)
<span class="lineno">   66 </span>import           Snap.Internal.Http.Server.Date           (getDateString)
<span class="lineno">   67 </span>import           Snap.Internal.Http.Server.Parser         (IRequest (..), getStdConnection, getStdContentLength, getStdContentType, getStdCookie, getStdHost, getStdTransferEncoding, parseCookie, parseRequest, parseUrlEncoded, readChunkedTransferEncoding, writeChunkedTransferEncoding)
<span class="lineno">   68 </span>import           Snap.Internal.Http.Server.Thread         (SnapThread)
<span class="lineno">   69 </span>import qualified Snap.Internal.Http.Server.Thread         as Thread
<span class="lineno">   70 </span>import           Snap.Internal.Http.Server.TimeoutManager (TimeoutManager)
<span class="lineno">   71 </span>import qualified Snap.Internal.Http.Server.TimeoutManager as TM
<span class="lineno">   72 </span>import           Snap.Internal.Http.Server.Types          (AcceptFunc (..), PerSessionData (..), SendFileHandler, ServerConfig (..), ServerHandler)
<span class="lineno">   73 </span>import           Snap.Internal.Http.Types                 (Cookie (..), HttpVersion, Method (..), Request (..), Response (..), ResponseBody (..), StreamProc, getHeader, headers, rspBodyToEnum, updateHeaders)
<span class="lineno">   74 </span>import           Snap.Internal.Parsing                    (unsafeFromNat)
<span class="lineno">   75 </span>import           Snap.Types.Headers                       (Headers)
<span class="lineno">   76 </span>import qualified Snap.Types.Headers                       as H
<span class="lineno">   77 </span>import           System.IO.Unsafe                         (unsafePerformIO)
<span class="lineno">   78 </span>
<span class="lineno">   79 </span>
<span class="lineno">   80 </span>------------------------------------------------------------------------------
<span class="lineno">   81 </span>data TerminateSessionException = TerminateSessionException SomeException
<span class="lineno">   82 </span>  deriving (Typeable, <span class="decl"><span class="istickedoff"><span class="decl"><span class="istickedoff">Show</span></span></span></span>)
<span class="lineno">   83 </span>instance Exception TerminateSessionException
<span class="lineno">   84 </span>
<span class="lineno">   85 </span>data BadRequestException = BadRequestException
<span class="lineno">   86 </span>  deriving (Typeable, <span class="decl"><span class="istickedoff"><span class="decl"><span class="istickedoff">Show</span></span></span></span>)
<span class="lineno">   87 </span>instance Exception BadRequestException
<span class="lineno">   88 </span>
<span class="lineno">   89 </span>data LengthRequiredException = LengthRequiredException
<span class="lineno">   90 </span>  deriving (Typeable, <span class="decl"><span class="istickedoff"><span class="decl"><span class="istickedoff">Show</span></span></span></span>)
<span class="lineno">   91 </span>instance Exception LengthRequiredException
<span class="lineno">   92 </span>
<span class="lineno">   93 </span>
<span class="lineno">   94 </span>------------------------------------------------------------------------------
<span class="lineno">   95 </span>snapToServerHandler :: Snap a -&gt; ServerHandler hookState
<span class="lineno">   96 </span><span class="decl"><span class="istickedoff">snapToServerHandler !snap !serverConfig !perSessionData !req =</span>
<span class="lineno">   97 </span><span class="spaces">    </span><span class="istickedoff">runSnap snap logErr tickle req</span>
<span class="lineno">   98 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">   99 </span><span class="spaces">    </span><span class="istickedoff">logErr = _logError serverConfig . byteString</span>
<span class="lineno">  100 </span><span class="spaces">    </span><span class="istickedoff">tickle = _twiddleTimeout perSessionData</span></span>
<span class="lineno">  101 </span>
<span class="lineno">  102 </span>
<span class="lineno">  103 </span>------------------------------------------------------------------------------
<span class="lineno">  104 </span>mAX_HEADERS_SIZE :: Int64
<span class="lineno">  105 </span><span class="decl"><span class="istickedoff">mAX_HEADERS_SIZE = 256 * 1024</span></span>
<span class="lineno">  106 </span>
<span class="lineno">  107 </span>
<span class="lineno">  108 </span>------------------------------------------------------------------------------
<span class="lineno">  109 </span>-- | For each cpu, we store:
<span class="lineno">  110 </span>--    * An accept thread
<span class="lineno">  111 </span>--    * A TimeoutManager
<span class="lineno">  112 </span>--    * An mvar to signal when the timeout thread is shutdown
<span class="lineno">  113 </span>data EventLoopCpu = EventLoopCpu
<span class="lineno">  114 </span>    { <span class="istickedoff"><span class="decl"><span class="istickedoff">_acceptThread</span></span></span>   :: SnapThread
<span class="lineno">  115 </span>    , <span class="istickedoff"><span class="decl"><span class="istickedoff">_timeoutManager</span></span></span> :: TimeoutManager
<span class="lineno">  116 </span>    }
<span class="lineno">  117 </span>
<span class="lineno">  118 </span>
<span class="lineno">  119 </span>------------------------------------------------------------------------------
<span class="lineno">  120 </span>-- | The main Snap webserver loop. Given a server handler, configuration, and a
<span class="lineno">  121 </span>-- function to accept new connections, runs an HTTP loop forever over N
<span class="lineno">  122 </span>-- threads, until a ThreadKilled exception is received.
<span class="lineno">  123 </span>httpAcceptLoop :: forall hookState .
<span class="lineno">  124 </span>                  ServerHandler hookState  -- ^ server handler
<span class="lineno">  125 </span>               -&gt; ServerConfig hookState   -- ^ server config
<span class="lineno">  126 </span>               -&gt; AcceptFunc               -- ^ accept function
<span class="lineno">  127 </span>               -&gt; IO ()
<span class="lineno">  128 </span><span class="decl"><span class="istickedoff">httpAcceptLoop serverHandler serverConfig acceptFunc = runLoops</span>
<span class="lineno">  129 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  130 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  131 </span><span class="spaces">    </span><span class="istickedoff">logError       = _logError serverConfig</span>
<span class="lineno">  132 </span><span class="spaces">    </span><span class="istickedoff">nLoops         = _numAcceptLoops serverConfig</span>
<span class="lineno">  133 </span><span class="spaces">    </span><span class="istickedoff">defaultTimeout = _defaultTimeout serverConfig</span>
<span class="lineno">  134 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  135 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  136 </span><span class="spaces">    </span><span class="istickedoff">logException :: Exception e =&gt; e -&gt; IO ()</span>
<span class="lineno">  137 </span><span class="spaces">    </span><span class="istickedoff">logException e =</span>
<span class="lineno">  138 </span><span class="spaces">        </span><span class="istickedoff">logError $</span>
<span class="lineno">  139 </span><span class="spaces">        </span><span class="istickedoff">mconcat [ byteString &quot;got exception in httpAcceptFunc: &quot;</span>
<span class="lineno">  140 </span><span class="spaces">                </span><span class="istickedoff">, fromShow e</span>
<span class="lineno">  141 </span><span class="spaces">                </span><span class="istickedoff">]</span>
<span class="lineno">  142 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  143 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  144 </span><span class="spaces">    </span><span class="istickedoff">runLoops = E.bracket (mapM newLoop [0 .. (nLoops - 1)])</span>
<span class="lineno">  145 </span><span class="spaces">                         </span><span class="istickedoff">(mapM_ killLoop)</span>
<span class="lineno">  146 </span><span class="spaces">                         </span><span class="istickedoff">(mapM_ waitLoop)</span>
<span class="lineno">  147 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  148 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  149 </span><span class="spaces">    </span><span class="istickedoff">loop :: TimeoutManager</span>
<span class="lineno">  150 </span><span class="spaces">         </span><span class="istickedoff">-&gt; (forall a. IO a -&gt; IO a)</span>
<span class="lineno">  151 </span><span class="spaces">         </span><span class="istickedoff">-&gt; IO ()</span>
<span class="lineno">  152 </span><span class="spaces">    </span><span class="istickedoff">loop tm loopRestore = eatException go</span>
<span class="lineno">  153 </span><span class="spaces">      </span><span class="istickedoff">where</span>
<span class="lineno">  154 </span><span class="spaces">        </span><span class="istickedoff">----------------------------------------------------------------------</span>
<span class="lineno">  155 </span><span class="spaces">        </span><span class="istickedoff">handlers =</span>
<span class="lineno">  156 </span><span class="spaces">            </span><span class="istickedoff">[ Handler $ \(e :: AsyncException) -&gt; loopRestore (E.throwIO $! e)</span>
<span class="lineno">  157 </span><span class="spaces">            </span><span class="istickedoff">, Handler $ \(e :: SomeException)  -&gt; logException e &gt;&gt; go</span>
<span class="lineno">  158 </span><span class="spaces">            </span><span class="istickedoff">]</span>
<span class="lineno">  159 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  160 </span><span class="spaces">        </span><span class="istickedoff">go = do</span>
<span class="lineno">  161 </span><span class="spaces">            </span><span class="istickedoff">(sendFileHandler, localAddress, localPort, remoteAddress,</span>
<span class="lineno">  162 </span><span class="spaces">             </span><span class="istickedoff">remotePort, readEnd, writeEnd,</span>
<span class="lineno">  163 </span><span class="spaces">             </span><span class="istickedoff">cleanup) &lt;- runAcceptFunc acceptFunc loopRestore</span>
<span class="lineno">  164 </span><span class="spaces">                                       </span><span class="istickedoff">`E.catches` handlers</span>
<span class="lineno">  165 </span><span class="spaces">            </span><span class="istickedoff">let threadLabel = S.concat [ &quot;snap-server: client &quot;</span>
<span class="lineno">  166 </span><span class="spaces">                                       </span><span class="istickedoff">, remoteAddress</span>
<span class="lineno">  167 </span><span class="spaces">                                       </span><span class="istickedoff">, &quot;:&quot;</span>
<span class="lineno">  168 </span><span class="spaces">                                       </span><span class="istickedoff">, S.pack $ show remotePort</span>
<span class="lineno">  169 </span><span class="spaces">                                       </span><span class="istickedoff">]</span>
<span class="lineno">  170 </span><span class="spaces">            </span><span class="istickedoff">thMVar &lt;- newEmptyMVar</span>
<span class="lineno">  171 </span><span class="spaces">            </span><span class="istickedoff">th &lt;- TM.register tm threadLabel $ \restore -&gt;</span>
<span class="lineno">  172 </span><span class="spaces">                    </span><span class="istickedoff">eatException $</span>
<span class="lineno">  173 </span><span class="spaces">                    </span><span class="istickedoff">prep thMVar sendFileHandler localAddress localPort remoteAddress</span>
<span class="lineno">  174 </span><span class="spaces">                         </span><span class="istickedoff">remotePort readEnd writeEnd cleanup restore</span>
<span class="lineno">  175 </span><span class="spaces">            </span><span class="istickedoff">putMVar thMVar th</span>
<span class="lineno">  176 </span><span class="spaces">            </span><span class="istickedoff">go</span>
<span class="lineno">  177 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  178 </span><span class="spaces">        </span><span class="istickedoff">prep :: MVar TM.TimeoutThread</span>
<span class="lineno">  179 </span><span class="spaces">             </span><span class="istickedoff">-&gt; SendFileHandler</span>
<span class="lineno">  180 </span><span class="spaces">             </span><span class="istickedoff">-&gt; ByteString</span>
<span class="lineno">  181 </span><span class="spaces">             </span><span class="istickedoff">-&gt; Int</span>
<span class="lineno">  182 </span><span class="spaces">             </span><span class="istickedoff">-&gt; ByteString</span>
<span class="lineno">  183 </span><span class="spaces">             </span><span class="istickedoff">-&gt; Int</span>
<span class="lineno">  184 </span><span class="spaces">             </span><span class="istickedoff">-&gt; InputStream ByteString</span>
<span class="lineno">  185 </span><span class="spaces">             </span><span class="istickedoff">-&gt; OutputStream ByteString</span>
<span class="lineno">  186 </span><span class="spaces">             </span><span class="istickedoff">-&gt; IO ()</span>
<span class="lineno">  187 </span><span class="spaces">             </span><span class="istickedoff">-&gt; (forall a . IO a -&gt; IO a)</span>
<span class="lineno">  188 </span><span class="spaces">             </span><span class="istickedoff">-&gt; IO ()</span>
<span class="lineno">  189 </span><span class="spaces">        </span><span class="istickedoff">prep thMVar sendFileHandler localAddress localPort remoteAddress</span>
<span class="lineno">  190 </span><span class="spaces">             </span><span class="istickedoff">remotePort readEnd writeEnd cleanup restore =</span>
<span class="lineno">  191 </span><span class="spaces">          </span><span class="istickedoff">do</span>
<span class="lineno">  192 </span><span class="spaces">            </span><span class="istickedoff">connClose &lt;- newIORef False</span>
<span class="lineno">  193 </span><span class="spaces">            </span><span class="istickedoff">newConn   &lt;- newIORef True</span>
<span class="lineno">  194 </span><span class="spaces">            </span><span class="istickedoff">let twiddleTimeout = unsafePerformIO $ do</span>
<span class="lineno">  195 </span><span class="spaces">                    </span><span class="istickedoff">th &lt;- readMVar thMVar</span>
<span class="lineno">  196 </span><span class="spaces">                    </span><span class="istickedoff">return $ TM.modify th</span>
<span class="lineno">  197 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  198 </span><span class="spaces">            </span><span class="istickedoff">let !psd = PerSessionData connClose</span>
<span class="lineno">  199 </span><span class="spaces">                                      </span><span class="istickedoff">twiddleTimeout</span>
<span class="lineno">  200 </span><span class="spaces">                                      </span><span class="istickedoff">newConn</span>
<span class="lineno">  201 </span><span class="spaces">                                      </span><span class="istickedoff">sendFileHandler</span>
<span class="lineno">  202 </span><span class="spaces">                                      </span><span class="istickedoff">localAddress</span>
<span class="lineno">  203 </span><span class="spaces">                                      </span><span class="istickedoff">localPort</span>
<span class="lineno">  204 </span><span class="spaces">                                      </span><span class="istickedoff">remoteAddress</span>
<span class="lineno">  205 </span><span class="spaces">                                      </span><span class="istickedoff">remotePort</span>
<span class="lineno">  206 </span><span class="spaces">                                      </span><span class="istickedoff">readEnd</span>
<span class="lineno">  207 </span><span class="spaces">                                      </span><span class="istickedoff">writeEnd</span>
<span class="lineno">  208 </span><span class="spaces">            </span><span class="istickedoff">restore (session psd) `E.finally` cleanup</span>
<span class="lineno">  209 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  210 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  211 </span><span class="spaces">    </span><span class="istickedoff">session psd = do</span>
<span class="lineno">  212 </span><span class="spaces">        </span><span class="istickedoff">buffer &lt;- newBuffer defaultChunkSize</span>
<span class="lineno">  213 </span><span class="spaces">        </span><span class="istickedoff">httpSession buffer serverHandler serverConfig psd</span>
<span class="lineno">  214 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  215 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  216 </span><span class="spaces">    </span><span class="istickedoff">newLoop cpu = E.mask_ $ do</span>
<span class="lineno">  217 </span><span class="spaces">        </span><span class="istickedoff">-- TODO(greg): move constant into config</span>
<span class="lineno">  218 </span><span class="spaces">        </span><span class="istickedoff">tm  &lt;- TM.initialize (fromIntegral defaultTimeout) 2 getClockTime</span>
<span class="lineno">  219 </span><span class="spaces">        </span><span class="istickedoff">let threadLabel = S.concat [ &quot;snap-server: accept loop #&quot;</span>
<span class="lineno">  220 </span><span class="spaces">                                   </span><span class="istickedoff">, S.pack $ show cpu</span>
<span class="lineno">  221 </span><span class="spaces">                                   </span><span class="istickedoff">]</span>
<span class="lineno">  222 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  223 </span><span class="spaces">        </span><span class="istickedoff">tid &lt;- Thread.forkOn threadLabel cpu $ loop tm</span>
<span class="lineno">  224 </span><span class="spaces">        </span><span class="istickedoff">return $! EventLoopCpu tid tm</span>
<span class="lineno">  225 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  226 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  227 </span><span class="spaces">    </span><span class="istickedoff">waitLoop (EventLoopCpu tid _) = Thread.wait tid</span>
<span class="lineno">  228 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  229 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  230 </span><span class="spaces">    </span><span class="istickedoff">killLoop ev = E.uninterruptibleMask_ $ do</span>
<span class="lineno">  231 </span><span class="spaces">        </span><span class="istickedoff">Thread.cancelAndWait tid</span>
<span class="lineno">  232 </span><span class="spaces">        </span><span class="istickedoff">TM.stop tm</span>
<span class="lineno">  233 </span><span class="spaces">      </span><span class="istickedoff">where</span>
<span class="lineno">  234 </span><span class="spaces">        </span><span class="istickedoff">tid = _acceptThread ev</span>
<span class="lineno">  235 </span><span class="spaces">        </span><span class="istickedoff">tm  = _timeoutManager ev</span></span>
<span class="lineno">  236 </span>
<span class="lineno">  237 </span>------------------------------------------------------------------------------
<span class="lineno">  238 </span>httpSession :: forall hookState .
<span class="lineno">  239 </span>               Buffer
<span class="lineno">  240 </span>            -&gt; ServerHandler hookState
<span class="lineno">  241 </span>            -&gt; ServerConfig hookState
<span class="lineno">  242 </span>            -&gt; PerSessionData
<span class="lineno">  243 </span>            -&gt; IO ()
<span class="lineno">  244 </span><span class="decl"><span class="istickedoff">httpSession !buffer !serverHandler !config !sessionData = loop</span>
<span class="lineno">  245 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  246 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  247 </span><span class="spaces">    </span><span class="istickedoff">defaultTimeout          = _defaultTimeout config</span>
<span class="lineno">  248 </span><span class="spaces">    </span><span class="istickedoff">isSecure                = _isSecure config</span>
<span class="lineno">  249 </span><span class="spaces">    </span><span class="istickedoff">localHostname           = _localHostname config</span>
<span class="lineno">  250 </span><span class="spaces">    </span><span class="istickedoff">logAccess               = _logAccess config</span>
<span class="lineno">  251 </span><span class="spaces">    </span><span class="istickedoff">logError                = _logError config</span>
<span class="lineno">  252 </span><span class="spaces">    </span><span class="istickedoff">newRequestHook          = _onNewRequest config</span>
<span class="lineno">  253 </span><span class="spaces">    </span><span class="istickedoff">parseHook               = _onParse config</span>
<span class="lineno">  254 </span><span class="spaces">    </span><span class="istickedoff">userHandlerFinishedHook = _onUserHandlerFinished config</span>
<span class="lineno">  255 </span><span class="spaces">    </span><span class="istickedoff">dataFinishedHook        = _onDataFinished config</span>
<span class="lineno">  256 </span><span class="spaces">    </span><span class="istickedoff">exceptionHook           = _onException config</span>
<span class="lineno">  257 </span><span class="spaces">    </span><span class="istickedoff">escapeHook              = _onEscape config</span>
<span class="lineno">  258 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  259 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  260 </span><span class="spaces">    </span><span class="istickedoff">forceConnectionClose    = _forceConnectionClose sessionData</span>
<span class="lineno">  261 </span><span class="spaces">    </span><span class="istickedoff">isNewConnection         = _isNewConnection sessionData</span>
<span class="lineno">  262 </span><span class="spaces">    </span><span class="istickedoff">localAddress            = _localAddress sessionData</span>
<span class="lineno">  263 </span><span class="spaces">    </span><span class="istickedoff">localPort               = _localPort sessionData</span>
<span class="lineno">  264 </span><span class="spaces">    </span><span class="istickedoff">remoteAddress           = _remoteAddress sessionData</span>
<span class="lineno">  265 </span><span class="spaces">    </span><span class="istickedoff">remotePort              = _remotePort sessionData</span>
<span class="lineno">  266 </span><span class="spaces">    </span><span class="istickedoff">readEnd                 = _readEnd sessionData</span>
<span class="lineno">  267 </span><span class="spaces">    </span><span class="istickedoff">tickle f                = _twiddleTimeout sessionData f</span>
<span class="lineno">  268 </span><span class="spaces">    </span><span class="istickedoff">writeEnd                = _writeEnd sessionData</span>
<span class="lineno">  269 </span><span class="spaces">    </span><span class="istickedoff">sendfileHandler         = _sendfileHandler sessionData</span>
<span class="lineno">  270 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  271 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  272 </span><span class="spaces">    </span><span class="istickedoff">mkBuffer :: IO (OutputStream Builder)</span>
<span class="lineno">  273 </span><span class="spaces">    </span><span class="istickedoff">mkBuffer = Streams.unsafeBuilderStream (return buffer) writeEnd</span>
<span class="lineno">  274 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  275 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  276 </span><span class="spaces">    </span><span class="istickedoff">-- Begin HTTP session processing.</span>
<span class="lineno">  277 </span><span class="spaces">    </span><span class="istickedoff">loop :: IO ()</span>
<span class="lineno">  278 </span><span class="spaces">    </span><span class="istickedoff">loop = do</span>
<span class="lineno">  279 </span><span class="spaces">        </span><span class="istickedoff">-- peek first to ensure startHook gets generated at the right time.</span>
<span class="lineno">  280 </span><span class="spaces">        </span><span class="istickedoff">readEndAtEof &gt;&gt;= (flip unless $ do</span>
<span class="lineno">  281 </span><span class="spaces">            </span><span class="istickedoff">hookState &lt;- newRequestHook sessionData &gt;&gt;= newIORef</span>
<span class="lineno">  282 </span><span class="spaces">            </span><span class="istickedoff">-- parse HTTP request</span>
<span class="lineno">  283 </span><span class="spaces">            </span><span class="istickedoff">req &lt;- receiveRequest</span>
<span class="lineno">  284 </span><span class="spaces">            </span><span class="istickedoff">parseHook hookState req</span>
<span class="lineno">  285 </span><span class="spaces">            </span><span class="istickedoff">processRequest hookState req)</span>
<span class="lineno">  286 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  287 </span><span class="spaces">    </span><span class="istickedoff">------------------------------------------------------------------------------</span>
<span class="lineno">  288 </span><span class="spaces">    </span><span class="istickedoff">readEndAtEof = Streams.read readEnd &gt;&gt;=</span>
<span class="lineno">  289 </span><span class="spaces">                   </span><span class="istickedoff">maybe (return True)</span>
<span class="lineno">  290 </span><span class="spaces">                         </span><span class="istickedoff">(\c -&gt; if S.null c</span>
<span class="lineno">  291 </span><span class="spaces">                                  </span><span class="istickedoff">then readEndAtEof</span>
<span class="lineno">  292 </span><span class="spaces">                                  </span><span class="istickedoff">else Streams.unRead c readEnd &gt;&gt; return False)</span>
<span class="lineno">  293 </span><span class="spaces">    </span><span class="istickedoff">{-# INLINE readEndAtEof #-}</span>
<span class="lineno">  294 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  295 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  296 </span><span class="spaces">    </span><span class="istickedoff">-- Read the HTTP request from the socket, parse it, and pre-process it.</span>
<span class="lineno">  297 </span><span class="spaces">    </span><span class="istickedoff">receiveRequest :: IO Request</span>
<span class="lineno">  298 </span><span class="spaces">    </span><span class="istickedoff">receiveRequest = {-# SCC &quot;httpSession/receiveRequest&quot; #-} do</span>
<span class="lineno">  299 </span><span class="spaces">        </span><span class="istickedoff">readEnd' &lt;- Streams.throwIfProducesMoreThan mAX_HEADERS_SIZE readEnd</span>
<span class="lineno">  300 </span><span class="spaces">        </span><span class="istickedoff">parseRequest readEnd' &gt;&gt;= toRequest</span>
<span class="lineno">  301 </span><span class="spaces">    </span><span class="istickedoff">{-# INLINE receiveRequest #-}</span>
<span class="lineno">  302 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  303 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  304 </span><span class="spaces">    </span><span class="istickedoff">toRequest :: IRequest -&gt; IO Request</span>
<span class="lineno">  305 </span><span class="spaces">    </span><span class="istickedoff">toRequest !ireq = {-# SCC &quot;httpSession/toRequest&quot; #-} do</span>
<span class="lineno">  306 </span><span class="spaces">        </span><span class="istickedoff">-- HTTP spec section 14.23: &quot;All Internet-based HTTP/1.1 servers MUST</span>
<span class="lineno">  307 </span><span class="spaces">        </span><span class="istickedoff">-- respond with a 400 (Bad Request) status code to any HTTP/1.1 request</span>
<span class="lineno">  308 </span><span class="spaces">        </span><span class="istickedoff">-- message which lacks a Host header field.&quot;</span>
<span class="lineno">  309 </span><span class="spaces">        </span><span class="istickedoff">--</span>
<span class="lineno">  310 </span><span class="spaces">        </span><span class="istickedoff">-- Here we interpret this slightly more liberally: if an absolute URI</span>
<span class="lineno">  311 </span><span class="spaces">        </span><span class="istickedoff">-- including a hostname is given in the request line, we'll take that</span>
<span class="lineno">  312 </span><span class="spaces">        </span><span class="istickedoff">-- if there's no Host header.</span>
<span class="lineno">  313 </span><span class="spaces">        </span><span class="istickedoff">--</span>
<span class="lineno">  314 </span><span class="spaces">        </span><span class="istickedoff">-- For HTTP/1.0 requests, we pick the configured local hostname by</span>
<span class="lineno">  315 </span><span class="spaces">        </span><span class="istickedoff">-- default.</span>
<span class="lineno">  316 </span><span class="spaces">        </span><span class="istickedoff">host &lt;- maybe (if isHttp11</span>
<span class="lineno">  317 </span><span class="spaces">                         </span><span class="istickedoff">then badRequestWithNoHost</span>
<span class="lineno">  318 </span><span class="spaces">                         </span><span class="istickedoff">else return localHostname)</span>
<span class="lineno">  319 </span><span class="spaces">                      </span><span class="istickedoff">return mbHost</span>
<span class="lineno">  320 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  321 </span><span class="spaces">        </span><span class="istickedoff">-- Call setupReadEnd, which handles transfer-encoding: chunked or</span>
<span class="lineno">  322 </span><span class="spaces">        </span><span class="istickedoff">-- content-length restrictions, etc</span>
<span class="lineno">  323 </span><span class="spaces">        </span><span class="istickedoff">!readEnd' &lt;- setupReadEnd</span>
<span class="lineno">  324 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  325 </span><span class="spaces">        </span><span class="istickedoff">-- Parse an application/x-www-form-urlencoded form, if it was sent</span>
<span class="lineno">  326 </span><span class="spaces">        </span><span class="istickedoff">(!readEnd'', postParams) &lt;- parseForm readEnd'</span>
<span class="lineno">  327 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  328 </span><span class="spaces">        </span><span class="istickedoff">let allParams = Map.unionWith (++) queryParams postParams</span>
<span class="lineno">  329 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  330 </span><span class="spaces">        </span><span class="istickedoff">-- Decide whether the connection should be closed after the response is</span>
<span class="lineno">  331 </span><span class="spaces">        </span><span class="istickedoff">-- sent (stored in the forceConnectionClose IORef).</span>
<span class="lineno">  332 </span><span class="spaces">        </span><span class="istickedoff">checkConnectionClose version $ getStdConnection stdHdrs</span>
<span class="lineno">  333 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  334 </span><span class="spaces">        </span><span class="istickedoff">-- The request is now ready for processing.</span>
<span class="lineno">  335 </span><span class="spaces">        </span><span class="istickedoff">return $! Request host</span>
<span class="lineno">  336 </span><span class="spaces">                          </span><span class="istickedoff">remoteAddress</span>
<span class="lineno">  337 </span><span class="spaces">                          </span><span class="istickedoff">remotePort</span>
<span class="lineno">  338 </span><span class="spaces">                          </span><span class="istickedoff">localAddress</span>
<span class="lineno">  339 </span><span class="spaces">                          </span><span class="istickedoff">localPort</span>
<span class="lineno">  340 </span><span class="spaces">                          </span><span class="istickedoff">localHost</span>
<span class="lineno">  341 </span><span class="spaces">                          </span><span class="istickedoff">isSecure</span>
<span class="lineno">  342 </span><span class="spaces">                          </span><span class="istickedoff">hdrs</span>
<span class="lineno">  343 </span><span class="spaces">                          </span><span class="istickedoff">readEnd''</span>
<span class="lineno">  344 </span><span class="spaces">                          </span><span class="istickedoff">mbCL</span>
<span class="lineno">  345 </span><span class="spaces">                          </span><span class="istickedoff">method</span>
<span class="lineno">  346 </span><span class="spaces">                          </span><span class="istickedoff">version</span>
<span class="lineno">  347 </span><span class="spaces">                          </span><span class="istickedoff">cookies</span>
<span class="lineno">  348 </span><span class="spaces">                          </span><span class="istickedoff">pathInfo</span>
<span class="lineno">  349 </span><span class="spaces">                          </span><span class="istickedoff">contextPath</span>
<span class="lineno">  350 </span><span class="spaces">                          </span><span class="istickedoff">uri</span>
<span class="lineno">  351 </span><span class="spaces">                          </span><span class="istickedoff">queryString</span>
<span class="lineno">  352 </span><span class="spaces">                          </span><span class="istickedoff">allParams</span>
<span class="lineno">  353 </span><span class="spaces">                          </span><span class="istickedoff">queryParams</span>
<span class="lineno">  354 </span><span class="spaces">                          </span><span class="istickedoff">postParams</span>
<span class="lineno">  355 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  356 </span><span class="spaces">      </span><span class="istickedoff">where</span>
<span class="lineno">  357 </span><span class="spaces">        </span><span class="istickedoff">----------------------------------------------------------------------</span>
<span class="lineno">  358 </span><span class="spaces">        </span><span class="istickedoff">!method       = iMethod ireq</span>
<span class="lineno">  359 </span><span class="spaces">        </span><span class="istickedoff">!version      = iHttpVersion ireq</span>
<span class="lineno">  360 </span><span class="spaces">        </span><span class="istickedoff">!stdHdrs      = iStdHeaders ireq</span>
<span class="lineno">  361 </span><span class="spaces">        </span><span class="istickedoff">!hdrs         = iRequestHeaders ireq</span>
<span class="lineno">  362 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  363 </span><span class="spaces">        </span><span class="istickedoff">!isHttp11     = version &gt;= (1, 1)</span>
<span class="lineno">  364 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  365 </span><span class="spaces">        </span><span class="istickedoff">!mbHost       = getStdHost stdHdrs</span>
<span class="lineno">  366 </span><span class="spaces">        </span><span class="istickedoff">!localHost    = fromMaybe localHostname mbHost</span>
<span class="lineno">  367 </span><span class="spaces">        </span><span class="istickedoff">mbCL          = unsafeFromNat &lt;$&gt;</span>
<span class="lineno">  368 </span><span class="spaces">                        </span><span class="istickedoff">getStdContentLength stdHdrs</span>
<span class="lineno">  369 </span><span class="spaces">        </span><span class="istickedoff">!isChunked    = (CI.mk &lt;$&gt; getStdTransferEncoding stdHdrs)</span>
<span class="lineno">  370 </span><span class="spaces">                            </span><span class="istickedoff">== Just &quot;chunked&quot;</span>
<span class="lineno">  371 </span><span class="spaces">        </span><span class="istickedoff">cookies       = fromMaybe [] (getStdCookie stdHdrs &gt;&gt;= parseCookie)</span>
<span class="lineno">  372 </span><span class="spaces">        </span><span class="istickedoff">contextPath   = &quot;/&quot;</span>
<span class="lineno">  373 </span><span class="spaces">        </span><span class="istickedoff">!uri          = iRequestUri ireq</span>
<span class="lineno">  374 </span><span class="spaces">        </span><span class="istickedoff">queryParams   = parseUrlEncoded queryString</span>
<span class="lineno">  375 </span><span class="spaces">        </span><span class="istickedoff">emptyParams   = Map.empty</span>
<span class="lineno">  376 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  377 </span><span class="spaces">        </span><span class="istickedoff">----------------------------------------------------------------------</span>
<span class="lineno">  378 </span><span class="spaces">        </span><span class="istickedoff">(pathInfo, queryString) = first dropLeadingSlash . second (S.drop 1)</span>
<span class="lineno">  379 </span><span class="spaces">                                    </span><span class="istickedoff">$ S.break (== '?') uri</span>
<span class="lineno">  380 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  381 </span><span class="spaces">        </span><span class="istickedoff">----------------------------------------------------------------------</span>
<span class="lineno">  382 </span><span class="spaces">        </span><span class="istickedoff">dropLeadingSlash s = if S.null s</span>
<span class="lineno">  383 </span><span class="spaces">                               </span><span class="istickedoff">then s</span>
<span class="lineno">  384 </span><span class="spaces">                               </span><span class="istickedoff">else let !a = S.unsafeIndex s 0</span>
<span class="lineno">  385 </span><span class="spaces">                                    </span><span class="istickedoff">in if a == 47   -- 47 == '/'</span>
<span class="lineno">  386 </span><span class="spaces">                                         </span><span class="istickedoff">then S.unsafeDrop 1 s</span>
<span class="lineno">  387 </span><span class="spaces">                                         </span><span class="istickedoff">else s</span>
<span class="lineno">  388 </span><span class="spaces">        </span><span class="istickedoff">{-# INLINE dropLeadingSlash #-}</span>
<span class="lineno">  389 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  390 </span><span class="spaces">        </span><span class="istickedoff">----------------------------------------------------------------------</span>
<span class="lineno">  391 </span><span class="spaces">        </span><span class="istickedoff">-- | We have to transform the read end of the socket, to limit the</span>
<span class="lineno">  392 </span><span class="spaces">        </span><span class="istickedoff">-- number of bytes read to the content-length, to decode chunked</span>
<span class="lineno">  393 </span><span class="spaces">        </span><span class="istickedoff">-- transfer encoding, or to immediately yield EOF if the request body</span>
<span class="lineno">  394 </span><span class="spaces">        </span><span class="istickedoff">-- is empty.</span>
<span class="lineno">  395 </span><span class="spaces">        </span><span class="istickedoff">setupReadEnd :: IO (InputStream ByteString)</span>
<span class="lineno">  396 </span><span class="spaces">        </span><span class="istickedoff">setupReadEnd =</span>
<span class="lineno">  397 </span><span class="spaces">            </span><span class="istickedoff">if isChunked</span>
<span class="lineno">  398 </span><span class="spaces">              </span><span class="istickedoff">then readChunkedTransferEncoding readEnd</span>
<span class="lineno">  399 </span><span class="spaces">              </span><span class="istickedoff">else maybe (const noContentLength)</span>
<span class="lineno">  400 </span><span class="spaces">                         </span><span class="istickedoff">(Streams.takeBytes . fromIntegral) mbCL readEnd</span>
<span class="lineno">  401 </span><span class="spaces">        </span><span class="istickedoff">{-# INLINE setupReadEnd #-}</span>
<span class="lineno">  402 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  403 </span><span class="spaces">        </span><span class="istickedoff">----------------------------------------------------------------------</span>
<span class="lineno">  404 </span><span class="spaces">        </span><span class="istickedoff">-- | If a request is not in chunked transfer encoding and lacks a</span>
<span class="lineno">  405 </span><span class="spaces">        </span><span class="istickedoff">-- content-length, the request body is null string.</span>
<span class="lineno">  406 </span><span class="spaces">        </span><span class="istickedoff">noContentLength :: IO (InputStream ByteString)</span>
<span class="lineno">  407 </span><span class="spaces">        </span><span class="istickedoff">noContentLength = do</span>
<span class="lineno">  408 </span><span class="spaces">            </span><span class="istickedoff">when (method == POST || method == PUT) return411</span>
<span class="lineno">  409 </span><span class="spaces">            </span><span class="istickedoff">Streams.fromList []</span>
<span class="lineno">  410 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  411 </span><span class="spaces">        </span><span class="istickedoff">----------------------------------------------------------------------</span>
<span class="lineno">  412 </span><span class="spaces">        </span><span class="istickedoff">return411 = do</span>
<span class="lineno">  413 </span><span class="spaces">            </span><span class="istickedoff">let (major, minor) = version</span>
<span class="lineno">  414 </span><span class="spaces">            </span><span class="istickedoff">let resp = mconcat [ byteString &quot;HTTP/&quot;</span>
<span class="lineno">  415 </span><span class="spaces">                               </span><span class="istickedoff">, fromShow major</span>
<span class="lineno">  416 </span><span class="spaces">                               </span><span class="istickedoff">, char8 '.'</span>
<span class="lineno">  417 </span><span class="spaces">                               </span><span class="istickedoff">, fromShow minor</span>
<span class="lineno">  418 </span><span class="spaces">                               </span><span class="istickedoff">, byteString &quot; 411 Length Required\r\n\r\n&quot;</span>
<span class="lineno">  419 </span><span class="spaces">                               </span><span class="istickedoff">, byteString &quot;411 Length Required\r\n&quot;</span>
<span class="lineno">  420 </span><span class="spaces">                               </span><span class="istickedoff">, flush</span>
<span class="lineno">  421 </span><span class="spaces">                               </span><span class="istickedoff">]</span>
<span class="lineno">  422 </span><span class="spaces">            </span><span class="istickedoff">writeEndB &lt;- mkBuffer</span>
<span class="lineno">  423 </span><span class="spaces">            </span><span class="istickedoff">Streams.write (Just resp) writeEndB</span>
<span class="lineno">  424 </span><span class="spaces">            </span><span class="istickedoff">Streams.write Nothing writeEndB</span>
<span class="lineno">  425 </span><span class="spaces">            </span><span class="istickedoff">terminateSession LengthRequiredException</span>
<span class="lineno">  426 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  427 </span><span class="spaces">        </span><span class="istickedoff">----------------------------------------------------------------------</span>
<span class="lineno">  428 </span><span class="spaces">        </span><span class="istickedoff">parseForm readEnd' = if hasForm</span>
<span class="lineno">  429 </span><span class="spaces">                               </span><span class="istickedoff">then getForm</span>
<span class="lineno">  430 </span><span class="spaces">                               </span><span class="istickedoff">else return (readEnd', emptyParams)</span>
<span class="lineno">  431 </span><span class="spaces">          </span><span class="istickedoff">where</span>
<span class="lineno">  432 </span><span class="spaces">            </span><span class="istickedoff">trimIt  = fst . S.spanEnd (== ' ') . S.takeWhile (/= ';')</span>
<span class="lineno">  433 </span><span class="spaces">                          </span><span class="istickedoff">. S.dropWhile (== ' ')</span>
<span class="lineno">  434 </span><span class="spaces">            </span><span class="istickedoff">mbCT    = trimIt &lt;$&gt; getStdContentType stdHdrs</span>
<span class="lineno">  435 </span><span class="spaces">            </span><span class="istickedoff">hasForm = mbCT == Just &quot;application/x-www-form-urlencoded&quot;</span>
<span class="lineno">  436 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  437 </span><span class="spaces">            </span><span class="istickedoff">mAX_POST_BODY_SIZE = 1024 * 1024</span>
<span class="lineno">  438 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  439 </span><span class="spaces">            </span><span class="istickedoff">getForm = do</span>
<span class="lineno">  440 </span><span class="spaces">                </span><span class="istickedoff">readEnd'' &lt;- Streams.throwIfProducesMoreThan</span>
<span class="lineno">  441 </span><span class="spaces">                               </span><span class="istickedoff">mAX_POST_BODY_SIZE readEnd'</span>
<span class="lineno">  442 </span><span class="spaces">                </span><span class="istickedoff">contents  &lt;- S.concat &lt;$&gt; Streams.toList readEnd''</span>
<span class="lineno">  443 </span><span class="spaces">                </span><span class="istickedoff">let postParams = parseUrlEncoded contents</span>
<span class="lineno">  444 </span><span class="spaces">                </span><span class="istickedoff">finalReadEnd &lt;- Streams.fromList [contents]</span>
<span class="lineno">  445 </span><span class="spaces">                </span><span class="istickedoff">return (finalReadEnd, postParams)</span>
<span class="lineno">  446 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  447 </span><span class="spaces">    </span><span class="istickedoff">----------------------------------------------------------------------</span>
<span class="lineno">  448 </span><span class="spaces">    </span><span class="istickedoff">checkConnectionClose version connection = do</span>
<span class="lineno">  449 </span><span class="spaces">        </span><span class="istickedoff">-- For HTTP/1.1: if there is an explicit Connection: close, we'll close</span>
<span class="lineno">  450 </span><span class="spaces">        </span><span class="istickedoff">-- the socket later.</span>
<span class="lineno">  451 </span><span class="spaces">        </span><span class="istickedoff">--</span>
<span class="lineno">  452 </span><span class="spaces">        </span><span class="istickedoff">-- For HTTP/1.0: if there is no explicit Connection: Keep-Alive,</span>
<span class="lineno">  453 </span><span class="spaces">        </span><span class="istickedoff">-- close the socket later.</span>
<span class="lineno">  454 </span><span class="spaces">        </span><span class="istickedoff">let v = CI.mk &lt;$&gt; connection</span>
<span class="lineno">  455 </span><span class="spaces">        </span><span class="istickedoff">when ((version == (1, 1) &amp;&amp; v == Just &quot;close&quot;) ||</span>
<span class="lineno">  456 </span><span class="spaces">              </span><span class="istickedoff">(version == (1, 0) &amp;&amp; v /= Just &quot;keep-alive&quot;)) $</span>
<span class="lineno">  457 </span><span class="spaces">              </span><span class="istickedoff">writeIORef forceConnectionClose True</span>
<span class="lineno">  458 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  459 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  460 </span><span class="spaces">    </span><span class="istickedoff">{-# INLINE badRequestWithNoHost #-}</span>
<span class="lineno">  461 </span><span class="spaces">    </span><span class="istickedoff">badRequestWithNoHost :: IO a</span>
<span class="lineno">  462 </span><span class="spaces">    </span><span class="istickedoff">badRequestWithNoHost = do</span>
<span class="lineno">  463 </span><span class="spaces">        </span><span class="istickedoff">let msg = mconcat [</span>
<span class="lineno">  464 </span><span class="spaces">                    </span><span class="istickedoff">byteString &quot;HTTP/1.1 400 Bad Request\r\n\r\n&quot;</span>
<span class="lineno">  465 </span><span class="spaces">                  </span><span class="istickedoff">, byteString &quot;400 Bad Request: HTTP/1.1 request with no &quot;</span>
<span class="lineno">  466 </span><span class="spaces">                  </span><span class="istickedoff">, byteString &quot;Host header\r\n&quot;</span>
<span class="lineno">  467 </span><span class="spaces">                  </span><span class="istickedoff">, flush</span>
<span class="lineno">  468 </span><span class="spaces">                  </span><span class="istickedoff">]</span>
<span class="lineno">  469 </span><span class="spaces">        </span><span class="istickedoff">writeEndB &lt;- mkBuffer</span>
<span class="lineno">  470 </span><span class="spaces">        </span><span class="istickedoff">Streams.write (Just msg) writeEndB</span>
<span class="lineno">  471 </span><span class="spaces">        </span><span class="istickedoff">Streams.write Nothing writeEndB</span>
<span class="lineno">  472 </span><span class="spaces">        </span><span class="istickedoff">terminateSession BadRequestException</span>
<span class="lineno">  473 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  474 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  475 </span><span class="spaces">    </span><span class="istickedoff">{-# INLINE checkExpect100Continue #-}</span>
<span class="lineno">  476 </span><span class="spaces">    </span><span class="istickedoff">checkExpect100Continue req =</span>
<span class="lineno">  477 </span><span class="spaces">        </span><span class="istickedoff">when (getHeader &quot;expect&quot; req == Just &quot;100-continue&quot;) $ do</span>
<span class="lineno">  478 </span><span class="spaces">            </span><span class="istickedoff">let v = if rqVersion req == (1,1) then &quot;HTTP/1.1&quot; else &quot;HTTP/1.0&quot;</span>
<span class="lineno">  479 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  480 </span><span class="spaces">            </span><span class="istickedoff">let hl = byteString v                       &lt;&gt;</span>
<span class="lineno">  481 </span><span class="spaces">                     </span><span class="istickedoff">byteString &quot; 100 Continue\r\n\r\n&quot; &lt;&gt;</span>
<span class="lineno">  482 </span><span class="spaces">                     </span><span class="istickedoff">flush</span>
<span class="lineno">  483 </span><span class="spaces">            </span><span class="istickedoff">os &lt;- mkBuffer</span>
<span class="lineno">  484 </span><span class="spaces">            </span><span class="istickedoff">Streams.write (Just hl) os</span>
<span class="lineno">  485 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  486 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  487 </span><span class="spaces">    </span><span class="istickedoff">{-# INLINE processRequest #-}</span>
<span class="lineno">  488 </span><span class="spaces">    </span><span class="istickedoff">processRequest !hookState !req = {-# SCC &quot;httpSession/processRequest&quot; #-} do</span>
<span class="lineno">  489 </span><span class="spaces">        </span><span class="istickedoff">-- successfully parsed a request, so restart the timer</span>
<span class="lineno">  490 </span><span class="spaces">        </span><span class="istickedoff">tickle $ max defaultTimeout</span>
<span class="lineno">  491 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  492 </span><span class="spaces">        </span><span class="istickedoff">-- check for Expect: 100-continue</span>
<span class="lineno">  493 </span><span class="spaces">        </span><span class="istickedoff">checkExpect100Continue req</span>
<span class="lineno">  494 </span><span class="spaces">        </span><span class="istickedoff">b &lt;- runServerHandler hookState req</span>
<span class="lineno">  495 </span><span class="spaces">               </span><span class="istickedoff">`E.catches` [ Handler $ escapeSnapHandler hookState</span>
<span class="lineno">  496 </span><span class="spaces">                           </span><span class="istickedoff">, Handler $</span>
<span class="lineno">  497 </span><span class="spaces">                             </span><span class="istickedoff">catchUserException hookState &quot;user handler&quot; req</span>
<span class="lineno">  498 </span><span class="spaces">                           </span><span class="istickedoff">]</span>
<span class="lineno">  499 </span><span class="spaces">        </span><span class="istickedoff">if b</span>
<span class="lineno">  500 </span><span class="spaces">          </span><span class="istickedoff">then do writeIORef isNewConnection False</span>
<span class="lineno">  501 </span><span class="spaces">                  </span><span class="istickedoff">-- the timer resets to its default value here.</span>
<span class="lineno">  502 </span><span class="spaces">                  </span><span class="istickedoff">loop</span>
<span class="lineno">  503 </span><span class="spaces">          </span><span class="istickedoff">else return $! ()</span>
<span class="lineno">  504 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  505 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  506 </span><span class="spaces">    </span><span class="istickedoff">{-# INLINE runServerHandler #-}</span>
<span class="lineno">  507 </span><span class="spaces">    </span><span class="istickedoff">runServerHandler !hookState !req = {-# SCC &quot;httpSession/runServerHandler&quot; #-} do</span>
<span class="lineno">  508 </span><span class="spaces">        </span><span class="istickedoff">(_, rsp0) &lt;- serverHandler config sessionData req</span>
<span class="lineno">  509 </span><span class="spaces">        </span><span class="istickedoff">userHandlerFinishedHook hookState req rsp0</span>
<span class="lineno">  510 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  511 </span><span class="spaces">        </span><span class="istickedoff">-- check whether we should close the connection after sending the</span>
<span class="lineno">  512 </span><span class="spaces">        </span><span class="istickedoff">-- response</span>
<span class="lineno">  513 </span><span class="spaces">        </span><span class="istickedoff">let v      = rqVersion req</span>
<span class="lineno">  514 </span><span class="spaces">        </span><span class="istickedoff">let is_1_0 = (v == (1,0))</span>
<span class="lineno">  515 </span><span class="spaces">        </span><span class="istickedoff">cc &lt;- if is_1_0 &amp;&amp; (isNothing $ rspContentLength rsp0)</span>
<span class="lineno">  516 </span><span class="spaces">                </span><span class="istickedoff">then return $! True</span>
<span class="lineno">  517 </span><span class="spaces">                </span><span class="istickedoff">else readIORef forceConnectionClose</span>
<span class="lineno">  518 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  519 </span><span class="spaces">        </span><span class="istickedoff">-- skip unread portion of request body if rspTransformingRqBody is not</span>
<span class="lineno">  520 </span><span class="spaces">        </span><span class="istickedoff">-- true</span>
<span class="lineno">  521 </span><span class="spaces">        </span><span class="istickedoff">unless (rspTransformingRqBody rsp0) $ Streams.skipToEof (rqBody req)</span>
<span class="lineno">  522 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  523 </span><span class="spaces">        </span><span class="istickedoff">!date &lt;- getDateString</span>
<span class="lineno">  524 </span><span class="spaces">        </span><span class="istickedoff">rsp1  &lt;- fixupResponse req rsp0</span>
<span class="lineno">  525 </span><span class="spaces">        </span><span class="istickedoff">let (!hdrs, !cc') = addDateAndServerHeaders is_1_0 date cc $</span>
<span class="lineno">  526 </span><span class="spaces">                            </span><span class="istickedoff">headers rsp1</span>
<span class="lineno">  527 </span><span class="spaces">        </span><span class="istickedoff">let rsp = updateHeaders (const hdrs) rsp1</span>
<span class="lineno">  528 </span><span class="spaces">        </span><span class="istickedoff">writeIORef forceConnectionClose cc'</span>
<span class="lineno">  529 </span><span class="spaces">        </span><span class="istickedoff">bytesSent &lt;- sendResponse req rsp `E.catch`</span>
<span class="lineno">  530 </span><span class="spaces">                     </span><span class="istickedoff">catchUserException hookState &quot;sending-response&quot; req</span>
<span class="lineno">  531 </span><span class="spaces">        </span><span class="istickedoff">dataFinishedHook hookState req rsp</span>
<span class="lineno">  532 </span><span class="spaces">        </span><span class="istickedoff">logAccess req rsp bytesSent</span>
<span class="lineno">  533 </span><span class="spaces">        </span><span class="istickedoff">return $! not cc'</span>
<span class="lineno">  534 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  535 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  536 </span><span class="spaces">    </span><span class="istickedoff">addDateAndServerHeaders !is1_0 !date !cc !hdrs =</span>
<span class="lineno">  537 </span><span class="spaces">        </span><span class="istickedoff">{-# SCC &quot;addDateAndServerHeaders&quot; #-}</span>
<span class="lineno">  538 </span><span class="spaces">        </span><span class="istickedoff">let (!hdrs', !newcc) = go [(&quot;date&quot;,date)] False cc</span>
<span class="lineno">  539 </span><span class="spaces">                                 </span><span class="istickedoff">$ H.unsafeToCaseFoldedList hdrs</span>
<span class="lineno">  540 </span><span class="spaces">        </span><span class="istickedoff">in (H.unsafeFromCaseFoldedList hdrs', newcc)</span>
<span class="lineno">  541 </span><span class="spaces">      </span><span class="istickedoff">where</span>
<span class="lineno">  542 </span><span class="spaces">        </span><span class="istickedoff">-- N.B.: here we know the date header has already been removed by</span>
<span class="lineno">  543 </span><span class="spaces">        </span><span class="istickedoff">-- &quot;fixupResponse&quot;.</span>
<span class="lineno">  544 </span><span class="spaces">        </span><span class="istickedoff">go !l !seenServer !connClose [] =</span>
<span class="lineno">  545 </span><span class="spaces">            </span><span class="istickedoff">let !l1 = if seenServer then l else ((&quot;server&quot;, sERVER_HEADER):l)</span>
<span class="lineno">  546 </span><span class="spaces">                </span><span class="istickedoff">!l2 = if connClose then ((&quot;connection&quot;, &quot;close&quot;):l1) else l1</span>
<span class="lineno">  547 </span><span class="spaces">            </span><span class="istickedoff">in (l2, connClose)</span>
<span class="lineno">  548 </span><span class="spaces">        </span><span class="istickedoff">go l _ c (x@(&quot;server&quot;,_):xs) = go (x:l) True c xs</span>
<span class="lineno">  549 </span><span class="spaces">        </span><span class="istickedoff">go l seenServer c (x@(&quot;connection&quot;, v):xs)</span>
<span class="lineno">  550 </span><span class="spaces">              </span><span class="istickedoff">| c = go l seenServer c xs</span>
<span class="lineno">  551 </span><span class="spaces">              </span><span class="istickedoff">| v == &quot;close&quot; || (is1_0 &amp;&amp; v /= &quot;keep-alive&quot;) =</span>
<span class="lineno">  552 </span><span class="spaces">                     </span><span class="istickedoff">go l seenServer True xs</span>
<span class="lineno">  553 </span><span class="spaces">              </span><span class="istickedoff">| <span class="tickonlytrue">otherwise</span> = go (x:l) seenServer c xs</span>
<span class="lineno">  554 </span><span class="spaces">        </span><span class="istickedoff">go l seenServer c (x:xs) = go (x:l) seenServer c xs</span>
<span class="lineno">  555 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  556 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  557 </span><span class="spaces">    </span><span class="istickedoff">escapeSnapHandler hookState (EscapeHttp escapeHandler) = do</span>
<span class="lineno">  558 </span><span class="spaces">        </span><span class="istickedoff">escapeHook hookState</span>
<span class="lineno">  559 </span><span class="spaces">        </span><span class="istickedoff">mkBuffer &gt;&gt;= escapeHandler tickle readEnd</span>
<span class="lineno">  560 </span><span class="spaces">        </span><span class="istickedoff">return False</span>
<span class="lineno">  561 </span><span class="spaces">    </span><span class="istickedoff">escapeSnapHandler _ (TerminateConnection e) = terminateSession e</span>
<span class="lineno">  562 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  563 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  564 </span><span class="spaces">    </span><span class="istickedoff">catchUserException :: IORef hookState</span>
<span class="lineno">  565 </span><span class="spaces">                       </span><span class="istickedoff">-&gt; ByteString</span>
<span class="lineno">  566 </span><span class="spaces">                       </span><span class="istickedoff">-&gt; Request</span>
<span class="lineno">  567 </span><span class="spaces">                       </span><span class="istickedoff">-&gt; SomeException</span>
<span class="lineno">  568 </span><span class="spaces">                       </span><span class="istickedoff">-&gt; IO a</span>
<span class="lineno">  569 </span><span class="spaces">    </span><span class="istickedoff">catchUserException hookState phase req e = do</span>
<span class="lineno">  570 </span><span class="spaces">        </span><span class="istickedoff">logError $ mconcat [</span>
<span class="lineno">  571 </span><span class="spaces">            </span><span class="istickedoff">byteString &quot;Exception leaked to httpSession during phase '&quot;</span>
<span class="lineno">  572 </span><span class="spaces">          </span><span class="istickedoff">, byteString phase</span>
<span class="lineno">  573 </span><span class="spaces">          </span><span class="istickedoff">, byteString &quot;': \n&quot;</span>
<span class="lineno">  574 </span><span class="spaces">          </span><span class="istickedoff">, requestErrorMessage req e</span>
<span class="lineno">  575 </span><span class="spaces">          </span><span class="istickedoff">]</span>
<span class="lineno">  576 </span><span class="spaces">        </span><span class="istickedoff">-- Note: the handler passed to httpSession needs to catch its own</span>
<span class="lineno">  577 </span><span class="spaces">        </span><span class="istickedoff">-- exceptions if it wants to avoid an ungracious exit here.</span>
<span class="lineno">  578 </span><span class="spaces">        </span><span class="istickedoff">eatException $ exceptionHook hookState e</span>
<span class="lineno">  579 </span><span class="spaces">        </span><span class="istickedoff">terminateSession e</span>
<span class="lineno">  580 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  581 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  582 </span><span class="spaces">    </span><span class="istickedoff">sendResponse :: Request -&gt; Response -&gt; IO Word64</span>
<span class="lineno">  583 </span><span class="spaces">    </span><span class="istickedoff">sendResponse !req !rsp = {-# SCC &quot;httpSession/sendResponse&quot; #-} do</span>
<span class="lineno">  584 </span><span class="spaces">        </span><span class="istickedoff">let !v          = rqVersion req</span>
<span class="lineno">  585 </span><span class="spaces">        </span><span class="istickedoff">let !hdrs'      = renderCookies rsp (headers rsp)</span>
<span class="lineno">  586 </span><span class="spaces">        </span><span class="istickedoff">let !code       = rspStatus rsp</span>
<span class="lineno">  587 </span><span class="spaces">        </span><span class="istickedoff">let body        = rspBody rsp</span>
<span class="lineno">  588 </span><span class="spaces">        </span><span class="istickedoff">let needChunked = rqMethod req /= HEAD</span>
<span class="lineno">  589 </span><span class="spaces">                            </span><span class="istickedoff">&amp;&amp; isNothing (rspContentLength rsp)</span>
<span class="lineno">  590 </span><span class="spaces">                            </span><span class="istickedoff">&amp;&amp; code /= 204</span>
<span class="lineno">  591 </span><span class="spaces">                            </span><span class="istickedoff">&amp;&amp; code /= 304</span>
<span class="lineno">  592 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  593 </span><span class="spaces">        </span><span class="istickedoff">let (hdrs'', body', shouldClose) = if needChunked</span>
<span class="lineno">  594 </span><span class="spaces">                                             </span><span class="istickedoff">then noCL req hdrs' body</span>
<span class="lineno">  595 </span><span class="spaces">                                             </span><span class="istickedoff">else (hdrs', body, False)</span>
<span class="lineno">  596 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  597 </span><span class="spaces">        </span><span class="istickedoff">when shouldClose $ writeIORef forceConnectionClose $! True</span>
<span class="lineno">  598 </span><span class="spaces">        </span><span class="istickedoff">let hdrPrim       = mkHeaderPrim v rsp hdrs''</span>
<span class="lineno">  599 </span><span class="spaces">        </span><span class="istickedoff">let hlen          = size hdrPrim</span>
<span class="lineno">  600 </span><span class="spaces">        </span><span class="istickedoff">let headerBuilder = primFixed hdrPrim $! ()</span>
<span class="lineno">  601 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  602 </span><span class="spaces">        </span><span class="istickedoff">nBodyBytes &lt;- case body' of</span>
<span class="lineno">  603 </span><span class="spaces">                        </span><span class="istickedoff">Stream s -&gt;</span>
<span class="lineno">  604 </span><span class="spaces">                            </span><span class="istickedoff">whenStream headerBuilder hlen rsp s</span>
<span class="lineno">  605 </span><span class="spaces">                        </span><span class="istickedoff">SendFile f Nothing -&gt;</span>
<span class="lineno">  606 </span><span class="spaces">                            </span><span class="istickedoff">whenSendFile headerBuilder rsp f 0</span>
<span class="lineno">  607 </span><span class="spaces">                        </span><span class="istickedoff">-- ignore end length here because we know we had a</span>
<span class="lineno">  608 </span><span class="spaces">                        </span><span class="istickedoff">-- content-length, use that instead.</span>
<span class="lineno">  609 </span><span class="spaces">                        </span><span class="istickedoff">SendFile f (Just (st, _)) -&gt;</span>
<span class="lineno">  610 </span><span class="spaces">                            </span><span class="istickedoff">whenSendFile headerBuilder rsp f st</span>
<span class="lineno">  611 </span><span class="spaces">        </span><span class="istickedoff">return $! nBodyBytes - fromIntegral hlen</span>
<span class="lineno">  612 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  613 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  614 </span><span class="spaces">    </span><span class="istickedoff">noCL :: Request</span>
<span class="lineno">  615 </span><span class="spaces">         </span><span class="istickedoff">-&gt; Headers</span>
<span class="lineno">  616 </span><span class="spaces">         </span><span class="istickedoff">-&gt; ResponseBody</span>
<span class="lineno">  617 </span><span class="spaces">         </span><span class="istickedoff">-&gt; (Headers, ResponseBody, Bool)</span>
<span class="lineno">  618 </span><span class="spaces">    </span><span class="istickedoff">noCL req hdrs body =</span>
<span class="lineno">  619 </span><span class="spaces">        </span><span class="istickedoff">if v == (1,1)</span>
<span class="lineno">  620 </span><span class="spaces">          </span><span class="istickedoff">then let origBody = rspBodyToEnum body</span>
<span class="lineno">  621 </span><span class="spaces">                   </span><span class="istickedoff">body'    = \os -&gt; do</span>
<span class="lineno">  622 </span><span class="spaces">                                 </span><span class="istickedoff">os' &lt;- writeChunkedTransferEncoding os</span>
<span class="lineno">  623 </span><span class="spaces">                                 </span><span class="istickedoff">origBody os'</span>
<span class="lineno">  624 </span><span class="spaces">               </span><span class="istickedoff">in ( H.set &quot;transfer-encoding&quot; &quot;chunked&quot; hdrs</span>
<span class="lineno">  625 </span><span class="spaces">                  </span><span class="istickedoff">, Stream body'</span>
<span class="lineno">  626 </span><span class="spaces">                  </span><span class="istickedoff">, False)</span>
<span class="lineno">  627 </span><span class="spaces">          </span><span class="istickedoff">else</span>
<span class="lineno">  628 </span><span class="spaces">            </span><span class="istickedoff">-- We've already noted that we have to close the socket earlier in</span>
<span class="lineno">  629 </span><span class="spaces">            </span><span class="istickedoff">-- runServerHandler.</span>
<span class="lineno">  630 </span><span class="spaces">            </span><span class="istickedoff">(hdrs, body, True)</span>
<span class="lineno">  631 </span><span class="spaces">      </span><span class="istickedoff">where</span>
<span class="lineno">  632 </span><span class="spaces">        </span><span class="istickedoff">v = rqVersion req</span>
<span class="lineno">  633 </span><span class="spaces">    </span><span class="istickedoff">{-# INLINE noCL #-}</span>
<span class="lineno">  634 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  635 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  636 </span><span class="spaces">    </span><span class="istickedoff">-- | If the response contains a content-length, make sure the response body</span>
<span class="lineno">  637 </span><span class="spaces">    </span><span class="istickedoff">-- StreamProc doesn't yield more (or fewer) than the given number of bytes.</span>
<span class="lineno">  638 </span><span class="spaces">    </span><span class="istickedoff">limitRspBody :: Int                      -- ^ header length</span>
<span class="lineno">  639 </span><span class="spaces">                 </span><span class="istickedoff">-&gt; Response                 -- ^ response</span>
<span class="lineno">  640 </span><span class="spaces">                 </span><span class="istickedoff">-&gt; OutputStream ByteString  -- ^ write end of socket</span>
<span class="lineno">  641 </span><span class="spaces">                 </span><span class="istickedoff">-&gt; IO (OutputStream ByteString)</span>
<span class="lineno">  642 </span><span class="spaces">    </span><span class="istickedoff">limitRspBody hlen rsp os = maybe (return os) f $ rspContentLength rsp</span>
<span class="lineno">  643 </span><span class="spaces">      </span><span class="istickedoff">where</span>
<span class="lineno">  644 </span><span class="spaces">        </span><span class="istickedoff">f cl = Streams.giveExactly (fromIntegral hlen + fromIntegral cl) os</span>
<span class="lineno">  645 </span><span class="spaces">    </span><span class="istickedoff">{-# INLINE limitRspBody #-}</span>
<span class="lineno">  646 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  647 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  648 </span><span class="spaces">    </span><span class="istickedoff">whenStream :: Builder       -- ^ headers</span>
<span class="lineno">  649 </span><span class="spaces">               </span><span class="istickedoff">-&gt; Int           -- ^ header length</span>
<span class="lineno">  650 </span><span class="spaces">               </span><span class="istickedoff">-&gt; Response      -- ^ response</span>
<span class="lineno">  651 </span><span class="spaces">               </span><span class="istickedoff">-&gt; StreamProc    -- ^ output body</span>
<span class="lineno">  652 </span><span class="spaces">               </span><span class="istickedoff">-&gt; IO Word64      -- ^ returns number of bytes written</span>
<span class="lineno">  653 </span><span class="spaces">    </span><span class="istickedoff">whenStream headerString hlen rsp body = do</span>
<span class="lineno">  654 </span><span class="spaces">        </span><span class="istickedoff">-- note:</span>
<span class="lineno">  655 </span><span class="spaces">        </span><span class="istickedoff">--</span>
<span class="lineno">  656 </span><span class="spaces">        </span><span class="istickedoff">--  * precondition here is that we have a content-length and that we're</span>
<span class="lineno">  657 </span><span class="spaces">        </span><span class="istickedoff">--    not using chunked transfer encoding.</span>
<span class="lineno">  658 </span><span class="spaces">        </span><span class="istickedoff">--</span>
<span class="lineno">  659 </span><span class="spaces">        </span><span class="istickedoff">--  * &quot;headerString&quot; includes http status line.</span>
<span class="lineno">  660 </span><span class="spaces">        </span><span class="istickedoff">--</span>
<span class="lineno">  661 </span><span class="spaces">        </span><span class="istickedoff">-- If you're transforming the request body, you have to manage your own</span>
<span class="lineno">  662 </span><span class="spaces">        </span><span class="istickedoff">-- timeouts.</span>
<span class="lineno">  663 </span><span class="spaces">        </span><span class="istickedoff">let t = if rspTransformingRqBody rsp</span>
<span class="lineno">  664 </span><span class="spaces">                  </span><span class="istickedoff">then return $! ()</span>
<span class="lineno">  665 </span><span class="spaces">                  </span><span class="istickedoff">else tickle $ max defaultTimeout</span>
<span class="lineno">  666 </span><span class="spaces">        </span><span class="istickedoff">writeEnd0 &lt;- Streams.ignoreEof writeEnd</span>
<span class="lineno">  667 </span><span class="spaces">        </span><span class="istickedoff">(writeEnd1, getCount) &lt;- Streams.countOutput writeEnd0</span>
<span class="lineno">  668 </span><span class="spaces">        </span><span class="istickedoff">writeEnd2 &lt;- limitRspBody hlen rsp writeEnd1</span>
<span class="lineno">  669 </span><span class="spaces">        </span><span class="istickedoff">writeEndB &lt;- Streams.unsafeBuilderStream (return buffer) writeEnd2 &gt;&gt;=</span>
<span class="lineno">  670 </span><span class="spaces">                     </span><span class="istickedoff">Streams.contramapM (\x -&gt; t &gt;&gt; return x)</span>
<span class="lineno">  671 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  672 </span><span class="spaces">        </span><span class="istickedoff">Streams.write (Just headerString) writeEndB</span>
<span class="lineno">  673 </span><span class="spaces">        </span><span class="istickedoff">writeEnd' &lt;- body writeEndB</span>
<span class="lineno">  674 </span><span class="spaces">        </span><span class="istickedoff">Streams.write Nothing writeEnd'</span>
<span class="lineno">  675 </span><span class="spaces">        </span><span class="istickedoff">-- Just in case the user handler didn't.</span>
<span class="lineno">  676 </span><span class="spaces">        </span><span class="istickedoff">Streams.write Nothing writeEnd1</span>
<span class="lineno">  677 </span><span class="spaces">        </span><span class="istickedoff">n &lt;- getCount</span>
<span class="lineno">  678 </span><span class="spaces">        </span><span class="istickedoff">return $! fromIntegral n - fromIntegral hlen</span>
<span class="lineno">  679 </span><span class="spaces">    </span><span class="istickedoff">{-# INLINE whenStream #-}</span>
<span class="lineno">  680 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  681 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  682 </span><span class="spaces">    </span><span class="istickedoff">whenSendFile :: Builder     -- ^ headers</span>
<span class="lineno">  683 </span><span class="spaces">                 </span><span class="istickedoff">-&gt; Response    -- ^ response</span>
<span class="lineno">  684 </span><span class="spaces">                 </span><span class="istickedoff">-&gt; FilePath    -- ^ file to serve</span>
<span class="lineno">  685 </span><span class="spaces">                 </span><span class="istickedoff">-&gt; Word64      -- ^ file start offset</span>
<span class="lineno">  686 </span><span class="spaces">                 </span><span class="istickedoff">-&gt; IO Word64   -- ^ returns number of bytes written</span>
<span class="lineno">  687 </span><span class="spaces">    </span><span class="istickedoff">whenSendFile headerString rsp filePath offset = do</span>
<span class="lineno">  688 </span><span class="spaces">        </span><span class="istickedoff">let !cl = fromJust $ rspContentLength rsp</span>
<span class="lineno">  689 </span><span class="spaces">        </span><span class="istickedoff">sendfileHandler buffer headerString filePath offset cl</span>
<span class="lineno">  690 </span><span class="spaces">        </span><span class="istickedoff">return cl</span>
<span class="lineno">  691 </span><span class="spaces">    </span><span class="istickedoff">{-# INLINE whenSendFile #-}</span></span>
<span class="lineno">  692 </span>
<span class="lineno">  693 </span>
<span class="lineno">  694 </span>--------------------------------------------------------------------------
<span class="lineno">  695 </span>mkHeaderLine :: HttpVersion -&gt; Response -&gt; FixedPrim ()
<span class="lineno">  696 </span><span class="decl"><span class="istickedoff">mkHeaderLine outVer r =</span>
<span class="lineno">  697 </span><span class="spaces">    </span><span class="istickedoff">case outCode of</span>
<span class="lineno">  698 </span><span class="spaces">        </span><span class="istickedoff">200 | outVer == (1, 1) -&gt;</span>
<span class="lineno">  699 </span><span class="spaces">                  </span><span class="istickedoff">-- typo in bytestring here</span>
<span class="lineno">  700 </span><span class="spaces">                  </span><span class="istickedoff">fixedPrim 17 $ const (void . cpBS &quot;HTTP/1.1 200 OK\r\n&quot;)</span>
<span class="lineno">  701 </span><span class="spaces">        </span><span class="istickedoff">200 | <span class="tickonlytrue">otherwise</span> -&gt;</span>
<span class="lineno">  702 </span><span class="spaces">                  </span><span class="istickedoff">fixedPrim 17 $ const (void . cpBS &quot;HTTP/1.0 200 OK\r\n&quot;)</span>
<span class="lineno">  703 </span><span class="spaces">        </span><span class="istickedoff">_ -&gt; fixedPrim len $ const (void . line)</span>
<span class="lineno">  704 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  705 </span><span class="spaces">    </span><span class="istickedoff">outCode = rspStatus r</span>
<span class="lineno">  706 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  707 </span><span class="spaces">    </span><span class="istickedoff">v = if outVer == (1,1) then &quot;HTTP/1.1 &quot; else &quot;HTTP/1.0 &quot;</span>
<span class="lineno">  708 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  709 </span><span class="spaces">    </span><span class="istickedoff">outCodeStr = S.pack $ show outCode</span>
<span class="lineno">  710 </span><span class="spaces">    </span><span class="istickedoff">space !op = do</span>
<span class="lineno">  711 </span><span class="spaces">        </span><span class="istickedoff">pokeByteOff op 0 (32 :: Word8)</span>
<span class="lineno">  712 </span><span class="spaces">        </span><span class="istickedoff">return $! plusPtr op 1</span>
<span class="lineno">  713 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  714 </span><span class="spaces">    </span><span class="istickedoff">line = cpBS v &gt;=&gt; cpBS outCodeStr &gt;=&gt; space &gt;=&gt; cpBS reason</span>
<span class="lineno">  715 </span><span class="spaces">                  </span><span class="istickedoff">&gt;=&gt; crlfPoke</span>
<span class="lineno">  716 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  717 </span><span class="spaces">    </span><span class="istickedoff">reason = rspStatusReason r</span>
<span class="lineno">  718 </span><span class="spaces">    </span><span class="istickedoff">len = 12 + S.length outCodeStr + S.length reason</span></span>
<span class="lineno">  719 </span>
<span class="lineno">  720 </span>
<span class="lineno">  721 </span>------------------------------------------------------------------------------
<span class="lineno">  722 </span>mkHeaderPrim :: HttpVersion -&gt; Response -&gt; Headers -&gt; FixedPrim ()
<span class="lineno">  723 </span><span class="decl"><span class="istickedoff">mkHeaderPrim v r hdrs = mkHeaderLine v r &lt;+&gt; headersToPrim hdrs</span></span>
<span class="lineno">  724 </span>
<span class="lineno">  725 </span>
<span class="lineno">  726 </span>------------------------------------------------------------------------------
<span class="lineno">  727 </span>infixl 4 &lt;+&gt;
<span class="lineno">  728 </span>(&lt;+&gt;) :: FixedPrim () -&gt; FixedPrim () -&gt; FixedPrim ()
<span class="lineno">  729 </span><span class="decl"><span class="istickedoff">p1 &lt;+&gt; p2 = ignore &gt;$&lt; p1 &gt;*&lt; p2</span>
<span class="lineno">  730 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  731 </span><span class="spaces">    </span><span class="istickedoff">ignore = join (,)</span></span>
<span class="lineno">  732 </span>
<span class="lineno">  733 </span>
<span class="lineno">  734 </span>------------------------------------------------------------------------------
<span class="lineno">  735 </span>{-# INLINE headersToPrim #-}
<span class="lineno">  736 </span>headersToPrim :: Headers -&gt; FixedPrim ()
<span class="lineno">  737 </span><span class="decl"><span class="istickedoff">headersToPrim hdrs = fixedPrim len (const copy)</span>
<span class="lineno">  738 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  739 </span><span class="spaces">    </span><span class="istickedoff">len = H.foldedFoldl' f 0 hdrs + 2</span>
<span class="lineno">  740 </span><span class="spaces">      </span><span class="istickedoff">where</span>
<span class="lineno">  741 </span><span class="spaces">        </span><span class="istickedoff">f l k v = l + S.length k + S.length v + 4</span>
<span class="lineno">  742 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  743 </span><span class="spaces">    </span><span class="istickedoff">copy = go $ H.unsafeToCaseFoldedList hdrs</span>
<span class="lineno">  744 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  745 </span><span class="spaces">    </span><span class="istickedoff">go []         !op = void $ crlfPoke op</span>
<span class="lineno">  746 </span><span class="spaces">    </span><span class="istickedoff">go ((k,v):xs) !op = do</span>
<span class="lineno">  747 </span><span class="spaces">        </span><span class="istickedoff">!op'  &lt;- cpBS k op</span>
<span class="lineno">  748 </span><span class="spaces">        </span><span class="istickedoff">pokeByteOff op' 0 (58 :: Word8)  -- colon</span>
<span class="lineno">  749 </span><span class="spaces">        </span><span class="istickedoff">pokeByteOff op' 1 (32 :: Word8)  -- space</span>
<span class="lineno">  750 </span><span class="spaces">        </span><span class="istickedoff">!op''  &lt;- cpBS v $ plusPtr op' 2</span>
<span class="lineno">  751 </span><span class="spaces">        </span><span class="istickedoff">crlfPoke op'' &gt;&gt;= go xs</span></span>
<span class="lineno">  752 </span>
<span class="lineno">  753 </span>
<span class="lineno">  754 </span>{-# INLINE cpBS #-}
<span class="lineno">  755 </span>cpBS :: ByteString -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
<span class="lineno">  756 </span><span class="decl"><span class="istickedoff">cpBS s !op = S.unsafeUseAsCStringLen s $ \(cstr, clen) -&gt; do</span>
<span class="lineno">  757 </span><span class="spaces">                </span><span class="istickedoff">let !cl = fromIntegral clen</span>
<span class="lineno">  758 </span><span class="spaces">                </span><span class="istickedoff">copyBytes op (castPtr cstr) cl</span>
<span class="lineno">  759 </span><span class="spaces">                </span><span class="istickedoff">return $! plusPtr op cl</span></span>
<span class="lineno">  760 </span>
<span class="lineno">  761 </span>{-# INLINE crlfPoke #-}
<span class="lineno">  762 </span>crlfPoke :: Ptr Word8 -&gt; IO (Ptr Word8)
<span class="lineno">  763 </span><span class="decl"><span class="istickedoff">crlfPoke !op = do</span>
<span class="lineno">  764 </span><span class="spaces">    </span><span class="istickedoff">pokeByteOff op 0 (13 :: Word8)  -- cr</span>
<span class="lineno">  765 </span><span class="spaces">    </span><span class="istickedoff">pokeByteOff op 1 (10 :: Word8)  -- lf</span>
<span class="lineno">  766 </span><span class="spaces">    </span><span class="istickedoff">return $! plusPtr op 2</span></span>
<span class="lineno">  767 </span>
<span class="lineno">  768 </span>
<span class="lineno">  769 </span>------------------------------------------------------------------------------
<span class="lineno">  770 </span>sERVER_HEADER :: ByteString
<span class="lineno">  771 </span><span class="decl"><span class="istickedoff">sERVER_HEADER = S.concat [&quot;Snap/&quot;, snapServerVersion]</span></span>
<span class="lineno">  772 </span>
<span class="lineno">  773 </span>
<span class="lineno">  774 </span>------------------------------------------------------------------------------
<span class="lineno">  775 </span>snapServerVersion :: ByteString
<span class="lineno">  776 </span><span class="decl"><span class="istickedoff">snapServerVersion = S.pack $ showVersion $ V.version</span></span>
<span class="lineno">  777 </span>
<span class="lineno">  778 </span>
<span class="lineno">  779 </span>------------------------------------------------------------------------------
<span class="lineno">  780 </span>terminateSession :: Exception e =&gt; e -&gt; IO a
<span class="lineno">  781 </span><span class="decl"><span class="istickedoff">terminateSession = E.throwIO . TerminateSessionException . SomeException</span></span>
<span class="lineno">  782 </span>
<span class="lineno">  783 </span>
<span class="lineno">  784 </span>------------------------------------------------------------------------------
<span class="lineno">  785 </span>requestErrorMessage :: Request -&gt; SomeException -&gt; Builder
<span class="lineno">  786 </span><span class="decl"><span class="istickedoff">requestErrorMessage req e =</span>
<span class="lineno">  787 </span><span class="spaces">    </span><span class="istickedoff">mconcat [ byteString &quot;During processing of request from &quot;</span>
<span class="lineno">  788 </span><span class="spaces">            </span><span class="istickedoff">, byteString $ rqClientAddr req</span>
<span class="lineno">  789 </span><span class="spaces">            </span><span class="istickedoff">, byteString &quot;:&quot;</span>
<span class="lineno">  790 </span><span class="spaces">            </span><span class="istickedoff">, fromShow $ rqClientPort req</span>
<span class="lineno">  791 </span><span class="spaces">            </span><span class="istickedoff">, byteString &quot;\nrequest:\n&quot;</span>
<span class="lineno">  792 </span><span class="spaces">            </span><span class="istickedoff">, fromShow $ show req</span>
<span class="lineno">  793 </span><span class="spaces">            </span><span class="istickedoff">, byteString &quot;\n&quot;</span>
<span class="lineno">  794 </span><span class="spaces">            </span><span class="istickedoff">, msgB</span>
<span class="lineno">  795 </span><span class="spaces">            </span><span class="istickedoff">]</span>
<span class="lineno">  796 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  797 </span><span class="spaces">    </span><span class="istickedoff">msgB = mconcat [</span>
<span class="lineno">  798 </span><span class="spaces">             </span><span class="istickedoff">byteString &quot;A web handler threw an exception. Details:\n&quot;</span>
<span class="lineno">  799 </span><span class="spaces">           </span><span class="istickedoff">, fromShow e</span>
<span class="lineno">  800 </span><span class="spaces">           </span><span class="istickedoff">]</span></span>
<span class="lineno">  801 </span>
<span class="lineno">  802 </span>
<span class="lineno">  803 </span>------------------------------------------------------------------------------
<span class="lineno">  804 </span>-- | Convert 'Cookie' into 'ByteString' for output.
<span class="lineno">  805 </span>cookieToBS :: Cookie -&gt; ByteString
<span class="lineno">  806 </span><span class="decl"><span class="istickedoff">cookieToBS (Cookie k v mbExpTime mbDomain mbPath isSec isHOnly) = cookie</span>
<span class="lineno">  807 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  808 </span><span class="spaces">    </span><span class="istickedoff">cookie  = S.concat [k, &quot;=&quot;, v, path, exptime, domain, secure, hOnly]</span>
<span class="lineno">  809 </span><span class="spaces">    </span><span class="istickedoff">path    = maybe &quot;&quot; (S.append &quot;; path=&quot;) mbPath</span>
<span class="lineno">  810 </span><span class="spaces">    </span><span class="istickedoff">domain  = maybe &quot;&quot; (S.append &quot;; domain=&quot;) mbDomain</span>
<span class="lineno">  811 </span><span class="spaces">    </span><span class="istickedoff">exptime = maybe &quot;&quot; (S.append &quot;; expires=&quot; . fmt) mbExpTime</span>
<span class="lineno">  812 </span><span class="spaces">    </span><span class="istickedoff">secure  = if isSec then &quot;; Secure&quot; else &quot;&quot;</span>
<span class="lineno">  813 </span><span class="spaces">    </span><span class="istickedoff">hOnly   = if isHOnly then &quot;; HttpOnly&quot; else &quot;&quot;</span>
<span class="lineno">  814 </span><span class="spaces">    </span><span class="istickedoff">fmt     = S.pack . formatTime defaultTimeLocale</span>
<span class="lineno">  815 </span><span class="spaces">                                  </span><span class="istickedoff">&quot;%a, %d-%b-%Y %H:%M:%S GMT&quot;</span></span>
<span class="lineno">  816 </span>
<span class="lineno">  817 </span>
<span class="lineno">  818 </span>------------------------------------------------------------------------------
<span class="lineno">  819 </span>renderCookies :: Response -&gt; Headers -&gt; Headers
<span class="lineno">  820 </span><span class="decl"><span class="istickedoff">renderCookies r hdrs</span>
<span class="lineno">  821 </span><span class="spaces">    </span><span class="istickedoff">| null cookies = hdrs</span>
<span class="lineno">  822 </span><span class="spaces">    </span><span class="istickedoff">| <span class="tickonlytrue">otherwise</span> = foldl' (\m v -&gt; H.unsafeInsert &quot;set-cookie&quot; v m) hdrs cookies</span>
<span class="lineno">  823 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  824 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  825 </span><span class="spaces">    </span><span class="istickedoff">cookies = fmap cookieToBS . Map.elems $ rspCookies r</span></span>
<span class="lineno">  826 </span>
<span class="lineno">  827 </span>------------------------------------------------------------------------------
<span class="lineno">  828 </span>fromShow :: Show a =&gt; a -&gt; Builder
<span class="lineno">  829 </span><span class="decl"><span class="istickedoff">fromShow = stringUtf8 . show</span></span>

</pre>
</body>
</html>
